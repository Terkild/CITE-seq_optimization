---
title: "CITE-seq optimization - Antibody titration"
author: "Terkild Brink Buus"
date: "30/3/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set()
options(stringsAsFactors=FALSE)
```

## Load libraries etc.

```{r}
set.seed(114)
require("Seurat")
require("tidyverse")

## Load ggplot theme and defaults
source("R/ggplot_settings.R")

## Load helper functions (ggplot themes, biexp transformation etc.)
source("R/Utilities.R")

## Load predefined color schemes
source("R/color.R")

outdir <- "C:/Users/Terkild/OneDrive - Københavns Universitet/Koralovlab/ECCITE-seq/20200106 Titration 1"
```

## Load Seurat object

```{r loadSeurat}
object <- readRDS(file="data/5P-CITE-seq_Titration.rds")

## Show number of cells from each sample
table(object$group)

object <- subset(object, subset=volume == "50µl")
object
```

## Cell type and tissue overview

```{r tsnePlots}
p.tsne.tissue <- DimPlot(object, group.by="tissue", reduction="tsne", pt.size=0.1, combine=FALSE)[[1]] + theme_get() + facet_wrap(~"Tissue") + scale_color_manual(values=color.tissue)

p.tsne.cluster <- DimPlot(object, group.by="supercluster", reduction="tsne", pt.size=0.1, combine=FALSE)[[1]] + theme_get() + scale_color_manual(values=color.supercluster) + facet_wrap(~"Cell types")

p.tsne.finecluster <- DimPlot(object, label=TRUE, label.size=3, reduction="tsne", pt.size=0.1, group.by="fineCluster", combine=FALSE)[[1]] + theme_get() + facet_wrap( ~"Clusters") + guides(col=F)

p.tsne.cluster + p.tsne.finecluster + p.tsne.tissue
```

## Overall ADT counts

Samples stained with diluted Ab panel have reduced ADT counts.

```{r ADTcounts}
ADTcount.Abtitration <- data.frame(FetchData(object, vars=c("dilution", "tissue")), count=apply(GetAssayData(object, assay="ADT.kallisto", slot="counts"),2,sum)) %>% group_by(tissue, dilution) %>% summarise(sum=sum(count))

p.ADTcount.Abtitration <- ggplot(ADTcount.Abtitration, aes(x=dilution, y=sum/10^6, fill=dilution)) + geom_bar(stat="identity", col="black") + facet_wrap(~tissue) + scale_fill_manual(values=color.dilution) + scale_y_continuous(expand=c(0,0,0,0.05)) + guides(fill=FALSE) + ylab("ADT UMI count (x10^6)") + theme(panel.grid.major=element_blank(), axis.title.x=element_blank(), panel.border=element_blank(), axis.line = element_line())

p.ADTcount.Abtitration
```

## ADT sum rank by cell

Samples stained with diluted Ab panel have reduced ADT counts evenly distributed among cells

```{r ADTrank}
source("R/foot_plot.R")
p.ADTrank.Abtitration <- foot_plot(data=object$nCount_ADT.kallisto, group=object$group, linetype=object$dilution, wrap=object$tissue, barcodeGroup=object$supercluster, draw.line=TRUE, draw.barcode=TRUE, draw.points=FALSE, draw.fractile=FALSE, trans="log10", barcode.stepSize = 0.1, colors=color.supercluster) + labs(linetype="Dilution factor", color="Cell type") + ylab("ADT UMI count")

p.ADTrank.Abtitration
```

## Load Ab panel annotation and concentrations

```{r loadABPanel}
abpanel <- data.frame(readxl::read_excel("data/Supplementary_Table_1.xlsx"))
rownames(abpanel) <- abpanel$Marker

markerStats <- read.table("data/markerByClusterStats.tsv")
markerStats.PBMC <- markerStats[markerStats$tissue == "PBMC",]
marker.order <- markerStats.PBMC$marker[order(-markerStats.PBMC$conc_µg_per_mL, -markerStats.PBMC$UMItotal)]
```

```{r titrationByCount}
ADT.matrix <- data.frame(GetAssayData(object, assay="ADT.kallisto", slot="counts"))
ADT.matrix$marker <- rownames(ADT.matrix)
ADT.matrix$conc <- abpanel[ADT.matrix$marker,"conc_µg_per_mL"]
ADT.matrix <- ADT.matrix %>% pivot_longer(c(-marker,-conc))
cell.annotation <- FetchData(object, vars=c("dilution", "tissue"))

ADT.matrix.agg <- ADT.matrix %>% group_by(dilution=cell.annotation[name,"dilution"], tissue=cell.annotation[name,"tissue"], marker, conc) %>% summarise(sum=sum(value))

ADT.matrix.agg$marker.byConc <- factor(ADT.matrix.agg$marker, levels=marker.order)

ann.markerConc <- abpanel[marker.order,]
ann.markerConc$Marker <- factor(marker.order, levels=marker.order)

lines <- length(marker.order)-cumsum(sapply(split(ann.markerConc$Marker,ann.markerConc$conc_µg_per_mL),length))+0.5
lines <- data.frame(breaks=lines[-length(lines)])

p1 <- ggplot(ann.markerConc, aes(x=1, y=Marker, fill=conc_µg_per_mL)) + 
  geom_tile(col=alpha(col="black",alpha=0.2)) + 
  geom_hline(data=lines,aes(yintercept=breaks), linetype="dashed", alpha=0.5) + 
  scale_fill_viridis_c(trans="log2") + 
  labs(fill="µg/mL") + 
  theme_get() + 
  theme(axis.ticks.x=element_blank(), axis.title = element_blank(), axis.text.x=element_blank(), panel.grid=element_blank(), legend.position="right", plot.margin=unit(c(0.1,0.1,0.1,0.1),"mm")) + scale_x_continuous(expand=c(0,0))
  
p2 <- ggplot(ADT.matrix.agg, aes(x=marker.byConc,y=log2(sum))) + 
  geom_line(aes(group=marker), size=1.2, color="#666666") + 
  geom_point(aes(group=dilution, fill=dilution), pch=21, size=0.7) + 
  geom_vline(data=lines,aes(xintercept=breaks), linetype="dashed", alpha=0.5) + 
  scale_fill_manual(values=color.dilution) + 
  facet_wrap(~tissue) + 
  scale_y_continuous(breaks=c(9:17)) + 
  ylab("log2(UMI sum)") + 
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="right", legend.justification="left", legend.title.align=0, legend.key.width=unit(0.2,"cm")) + 
  coord_flip()

library(patchwork)
titration.totalCount <- p1 + guides(fill=F) + p2 + guides(fill=F) + plot_spacer() + guide_area() + plot_layout(ncol=4, widths=c(1,30,0.1), guides='collect')

titration.totalCount
```

## Overall ADT counts

Samples stained with diluted Ab panel have reduced ADT counts.

```{r ADTcountsByConc}
scaleFUN <- function(x) sprintf("%.2f", x)

p.ADTcount.AbtitrationByConc <- ggplot(ADT.matrix.agg[order(-ADT.matrix.agg$conc, -ADT.matrix.agg$sum),], aes(x=dilution, y=sum/10^6, fill=conc)) + 
  geom_bar(stat="identity", col=alpha(col="black",alpha=0.05)) + 
  scale_fill_viridis_c(trans="log2", labels=scaleFUN, breaks=c(0.0375,0.15,0.625,2.5,10)) + 
  scale_y_continuous(expand=c(0,0,0,0.05)) + 
  labs(fill="µg/mL", y=bquote("ADT UMI counts ("~10^6~")")) + 
  guides(fill=guide_colourbar(reverse=T)) + 
  facet_wrap(~tissue) + 
  theme(panel.grid.major=element_blank(), axis.title.x=element_blank(), panel.border=element_blank(), axis.line = element_line(), legend.position="right")

p.ADTcount.AbtitrationByConc
```

Plot change by dilution. We modified our approach of using a specific fractile as this may be prone to outliers in small clusters (i.e. the 0.9 fractile of a cluster of 30 will be the #3 higest cell making it prone to outliers). We thus set a threshhold of the value to be lower than the expression of the 10th highest cell value within the cluster with highest expression.

```{r TitrationByCluster}

ADT.matrix <- data.frame(GetAssayData(object, assay="ADT.kallisto", slot="counts"))
ADT.matrix$marker <- rownames(ADT.matrix)
ADT.matrix$conc <- abpanel[ADT.matrix$marker,"conc_µg_per_mL"]
ADT.matrix <- ADT.matrix %>% pivot_longer(c(-marker,-conc))

cell.annotation <- FetchData(object, vars=c("dilution", "tissue", "fineCluster"))

ADT.matrix.agg <- ADT.matrix %>% group_by(dilution=cell.annotation[name,"dilution"], tissue=cell.annotation[name,"tissue"], fineCluster=cell.annotation[name,"fineCluster"], marker, conc) %>% summarise(sum=sum(value), median=quantile(value, probs=c(0.9)), nth=nth(value))

Cluster.max <- markerStats[,c("marker","tissue","fineCluster")]
Cluster.max$fineCluster <- factor(Cluster.max$fineCluster)
Cluster.max$tissue <- factor(Cluster.max$tissue, levels=c("PBMC","Lung"))

ADT.matrix.aggByClusterMax <- Cluster.max %>% left_join(ADT.matrix.agg)
ADT.matrix.aggByClusterMax$marker.byConc <- factor(ADT.matrix.aggByClusterMax$marker, levels=marker.order)

p3 <- ggplot(ADT.matrix.aggByClusterMax, aes(x=marker.byConc, y=log2(nth))) + 
  geom_line(aes(group=marker), size=1.2, color="#666666") + 
  geom_point(aes(group=dilution, fill=dilution), pch=21, size=0.7) + 
  geom_vline(data=lines,aes(xintercept=breaks), linetype="dashed", alpha=0.5) + 
  geom_text(aes(label=paste0(fineCluster," ")), y=Inf, adj=1, size=1.5) + 
  facet_wrap(~tissue) + 
  scale_fill_manual(values=color.dilution) + 
  scale_y_continuous(breaks=c(0:11), labels=2^c(0:11), expand=c(0.05,0.5)) + 
  ylab("90th percentile UMI of expressing cluster") + 
  theme(axis.title.y=element_blank(), axis.text.y=element_blank(), legend.position="right", legend.justification="left", legend.title.align=0, legend.key.width=unit(0.2,"cm")) + 
  coord_flip()

titration.clusterCount <- p1 + theme(legend.position="none") + p3 + theme(legend.position="none") + plot_spacer() + plot_layout(ncol=4, widths=c(1,30,0.1), guides='collect')

titration.clusterCount
```

## Final plot

```{r Figure1}
## First row of plots
A <- p.tsne.cluster + theme(axis.text.x=element_blank(), axis.text.y=element_blank(), axis.title.x=element_blank(), axis.title.y=element_text()) + theme(legend.position=c(0.5,0.01), legend.justification=c(0.5,1), legend.margin=margin(0,0,0,0), legend.title = element_blank(), legend.background=element_blank(), plot.margin = unit(c(1,1,5,1),"mm")) + guides(color=guide_legend(ncol=2, override.aes=list(shape=19, size=1.5), keyheight=unit(0.25, "cm"), keywidth=unit(0.15, "cm")))
B <- p.tsne.finecluster + theme(axis.text.x=element_blank(), axis.text.y=element_blank(), axis.title.y=element_blank(), axis.title.x=element_text())
C <- p.tsne.tissue + theme(axis.text.x=element_blank(), axis.text.y=element_blank(), axis.title.y=element_blank(),axis.title.x=element_blank()) + theme(legend.position=c(0.5,0.01), legend.justification=c(0.5,2), legend.margin=margin(0,0,0,0), legend.title = element_blank(), legend.direction="horizontal", legend.background=element_blank()) + guides(color=guide_legend(override.aes=list(shape=19, size=1.5), keyheight=unit(0.25, "cm"), keywidth=unit(0.15, "cm")))

D <- p.ADTcount.AbtitrationByConc + theme(legend.key.width=unit(0.3,"cm"), legend.key.height=unit(0.4,"cm"), legend.text=element_text(size=unit(5,"pt")))

E1 <- p1
E.legend <- cowplot::get_legend(E1)
E1 <- E1 + theme(legend.position="none")
E2 <- p2
E2 <- E2 + theme(legend.position="none")
F1 <- p3 + theme(legend.position="none")



AD <- cowplot::plot_grid(A, B, C, D, labels=c("A", "B", "C", "D"), label_size=panel.label_size, nrow=1, vjust=panel.label_vjust, hjust=panel.label_hjust, align="h", axis="tb", rel_widths = c(2.2,2,2,2.2))

EF <- cowplot::plot_grid(E1, E2, E1, F1, nrow=1, align="h", axis="tb", labels=c("E", "", "F", ""), label_size=panel.label_size, vjust=panel.label_vjust, hjust=panel.label_hjust, rel_widths=c(2,10,2,10))

png(file=file.path(outdir,"Figure 1.png"), width=figure.width.full, height=6.3, units = figure.unit, res=figure.resolution, antialias=figure.antialias)
cowplot::plot_grid(AD, EF, ncol=1, rel_heights=c(2.4,5), align="v", axis="l")
dev.off()
```

## Titration examples

```{r titrationExamples}

## Partial responders that can be economically titrated
# CD4, CD19, CD103
curMarker.name <- "CD4"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.28,0.50))

p.CD4 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

curMarker.name <- "CD19"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.92,0.75))

p.CD19 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

curMarker.name <- "HLA-DR"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.47,0.295))

p.HLADR <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

A <- cowplot::plot_grid(p.HLADR, p.CD4, p.CD19, nrow=1)

## Markers that should not be reduced
# CD39, CD14, CD3
curMarker.name <- "CD3"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.56,0.46))

p.CD3 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

curMarker.name <- "CD14"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.68,0.86))

p.CD14 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

curMarker.name <- "CD39"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0.54,0.33))

p.CD39 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

B <- cowplot::plot_grid(p.CD3, p.CD14, p.CD39, nrow=1)

## Ubiqutously expressed markers
# HLA-ABC, CD44, CD45
curMarker.name <- "HLA-ABC"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]

p.HLA <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, legend=FALSE)

curMarker.name <- "CD44"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]

p.CD44 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, legend=FALSE)

curMarker.name <- "CD45"
curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
gate <- data.frame(wrap=factor(c("PBMC","Lung"),levels=c("PBMC","Lung")),gate=c(0,0.05))

p.CD45 <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, gates=gate, legend=FALSE)

# a bit of a hack to get celltype legend
p.withLegend <- ggplot(data.frame(supercluster=object$supercluster),aes(color=supercluster,x=1,y=1)) + geom_point(shape=15, size=1.5)
p.legend <- cowplot::get_legend(p.withLegend + theme(legend.title=element_blank(),legend.margin=margin(0,0,0,0), legend.key.size = unit(0.15,"cm"),legend.position = c(0.98,1.1), legend.justification=c(1,1), legend.direction="horizontal"))

C <- cowplot::plot_grid(p.HLA, p.CD44, p.CD45, nrow=1)

png(file=file.path(outdir,"Figure 2.png"), units=figure.unit, res=figure.resolution, width=figure.width.full, height=6, antialias=figure.antialias)
cowplot::plot_grid(NULL, p.legend, A, NULL, B, NULL, C, labels=c("","","A","","B","","C"), vjust=-0.5, hjust=panel.label_hjust, label_size=panel.label_size, ncol=1, rel_heights= c(1.3,1.5,20,1.5,20,1.5,20))
dev.off()


```


## Print individual titration plots (for each marker)

For supplementary figure

```{r suppFig1, eval=TRUE}

plots <- list()
markers <- intersect(abpanel[order(desc(abpanel$conc_µg_per_mL), abpanel$Marker),"Marker"],rownames(object[["ADT.kallisto"]]))

for(i in seq_along(markers)){
  curMarker.name <- markers[i]
  curMarker.DF1conc <- abpanel[curMarker.name, "conc_µg_per_mL"]
  plot <- foot_plot_density_custom(marker=paste0("adt_",curMarker.name), conc=curMarker.DF1conc, legend=FALSE)
  plots[[i]] <- plot
}

png(file=file.path(outdir,"Supplementary Figure 1A.png"), units=figure.unit, res=figure.resolution, width=figure.width.full, height=10, antialias=figure.antialias)
curPlots <- plot_grid(plotlist=plots[1:15],ncol=3, align="h", axis="tb")
cowplot::plot_grid(NULL, p.legend, curPlots, vjust=-0.5, hjust=panel.label_hjust, label_size=panel.label_size, ncol=1, rel_heights= c(0.5, 1.3, 70))
dev.off()
png(file=file.path(outdir,"Supplementary Figure 1B.png"), units=figure.unit, res=figure.resolution, width=figure.width.full, height=10, antialias=figure.antialias)
curPlots <- plot_grid(plotlist=plots[16:30],ncol=3, align="h", axis="tb")
cowplot::plot_grid(NULL, p.legend, curPlots, vjust=-0.5, hjust=panel.label_hjust, label_size=panel.label_size, ncol=1, rel_heights= c(0.5, 1.3, 70))
dev.off()
png(file=file.path(outdir,"Supplementary Figure 1C.png"), units=figure.unit, res=figure.resolution, width=figure.width.full, height=10, antialias=figure.antialias)
curPlots <- plot_grid(plotlist=plots[31:45],ncol=3, align="h", axis="tb")
cowplot::plot_grid(NULL, p.legend, curPlots, vjust=-0.5, hjust=panel.label_hjust, label_size=panel.label_size, ncol=1, rel_heights= c(0.5, 1.3, 70))
dev.off()
png(file=file.path(outdir,"Supplementary Figure 1D.png"), units=figure.unit, res=figure.resolution, width=figure.width.full, height=10, antialias=figure.antialias)
curPlots <- plot_grid(plotlist=plots[46:52],ncol=3, align="h", axis="tb")
cowplot::plot_grid(NULL, p.legend, curPlots, NULL, vjust=-0.5, hjust=panel.label_hjust, label_size=panel.label_size, ncol=1, rel_heights= c(0.5, 1.3, 70*(3/5),70*(2/5)))
dev.off()

```

